{% extends 'base.html' %}

{% load static %}
{% block content %}
<div class="flex w-full justify-center py-5">
  {{ group.group_name }}
  <!-- You can open the modal using ID.showModal() method -->
   <!-- TODO: Make font sizes consistent -->
  <button class="" onclick="usergroup_settings_modal.showModal()">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 ml-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 0 1 1.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.559.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.894.149c-.424.07-.764.383-.929.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 0 1-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.398.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 0 1-.12-1.45l.527-.737c.25-.35.272-.806.108-1.204-.165-.397-.506-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.108-1.204l-.526-.738a1.125 1.125 0 0 1 .12-1.45l.773-.773a1.125 1.125 0 0 1 1.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894Z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
    </svg>    
  </button>
  {% include 'group_settings_modal.html' %}
</div>

<!-- Using flex to manage layout -->
<div class="flex w-full h-[calc(100vh-10rem)]">
  <!-- Left Column (50% of the width) -->
  <div class="w-1/2 border-solid rounded-md border-2 overflow-auto p-5 ml-5">
    <div class="prose break-words text-sm">
      <a class="text-secondary" href="{{ group.question.link }}" target="_blank">{{ group.question.title }}</a>
      {{ group.question.content|safe }}
    </div>
  </div>

  <!-- Right Column (Stacked boxes) -->
  <div class="w-1/2 flex flex-col">
    <!-- First Box -->
    <div class="border-solid rounded-md border-2 overflow-auto p-5 ml-2.5 mr-5">
      <div class="flex justify-between">
        <h3>Members</h3>
        <div class="flex flex-row">
          <button class="btn btn-outline btn-primary btn-xs flex">Invite</button>
          <!-- TODO: Form looks like it added some padding -->
           <button hx-get="{% url 'refresh_group_data' group.invite_code %}" 
                   hx-target="#group-table"
                   hx-swap="OuterHTML"
                   class="ml-5">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
           </button>
        </form>
        </div>
      </div>
      <div id="group-table">
        {% include 'partials/members_table.html' %}
      </div>
    </div>
    
    <!-- Second Box -->
    <div class="border-solid rounded-md border-2 overflow-auto p-5 ml-2.5 mr-5 mt-5">
        <div id="editor-container" code-content="{{ solution.code }}" style="width: 100%; height: 400px;"></div>
      
      <!-- Hidden div with HTMX attributes for autosave -->
      <div id="autosave-trigger" 
        hx-post="./save_solution/"
        hx-target="#save-status"
        hx-swap="outerHTML"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-trigger="autosave-event from:body"
        style="display:none;">
      </div>
      <div id="save-status" class="text-sm text-gray-500 mt-2">Changes saved automatically</div>
    </div>
      {% endblock %}
      {% block extra_scripts %}
      <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
      <script>
        let editor;
        let saveTimeout;
        const AUTOSAVE_DELAY = 1000; // 1 second delay after typing stops
        let code_content = document.getElementById('editor-container').getAttribute('code-content');
        console.log(code_content);
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
          // Create and store the editor instance
          editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: code_content,
            language: 'python',
            theme: 'vs-light',
            minimap: { enabled: false },
            automaticLayout: true,
            fontSize: 14,
            lineNumbers: 'off',
            scrollBeyondLastLine: false,
            suggestOnTriggerCharacters: false,
            quickSuggestions: false,
            renderLineHighlight: 'none',
            hideCursorInOverviewRuler: true,
            overviewRulerLanes: 0,
            overviewRulerBorder: false,
            scrollbar: {
              vertical: 'visible',
              horizontal: 'visible',
              useShadows: false,
              verticalHasArrows: false,
              horizontalHasArrows: false,
              verticalScrollbarSize: 10,
              horizontalScrollbarSize: 10
            }
          });
          
          // Add change event listener for autosave
          editor.onDidChangeModelContent(() => {
            // Show "Saving..." status
            document.getElementById('save-status').innerHTML = 'Saving...';
            
            // Clear previous timeout if it exists
            if (saveTimeout) {
              clearTimeout(saveTimeout);
            }
            
            // Set a new timeout to trigger save after user stops typing
            saveTimeout = setTimeout(() => {
              triggerAutosave();
            }, AUTOSAVE_DELAY);
          });
          
          // Configure the HTMX request to include editor content
          document.getElementById('autosave-trigger').addEventListener('htmx:configRequest', function(event) {
            const content = editor.getValue();
            event.detail.parameters.content = content;
          });
        });
        
        // Function to trigger the HTMX autosave
        function triggerAutosave() {
          // Dispatch a custom event that HTMX is listening for
          document.body.dispatchEvent(new CustomEvent('autosave-event'));
        }
      </script>
      {% endblock %}